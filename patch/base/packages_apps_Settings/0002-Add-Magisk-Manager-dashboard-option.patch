From c10c8ec2642daf0d4b4e3d46bf3acd5788cc2a9c Mon Sep 17 00:00:00 2001
From: sub77 <sub77@ymail.com>
Date: Sun, 5 Mar 2017 00:57:54 +0000
Subject: [PATCH 2/2] Add Magisk Manager dashboard option

The primary reason for bringing this into the dashboard is that the
Magisk Manager will soon have root management options, meaning that
people will no longer need the Superuser app

I would have liked to use the actual Magisk icon from within the app
but it just does not look good at lower DPIs so I picked a tuning icon
from https://materialdesignicons.com/

Preview with summary: http://i.imgur.com/Zc1FJN8.png

Change-Id: If7df9976d371b29797ec4c237c77c7489f6a3541
Signed-off-by: Nathan Chancellor <natechancellor@gmail.com>

GZR: Made a vector to match magiskmanager arranged custom dash setting a lil bit
---
 AndroidManifest.xml                            | 22 ++++++++++++++++++++++
 res/drawable/ic_settings_magisk.xml            | 14 ++++++++++++++
 res/values/projekt_strings.xml                 |  4 ++++
 src/com/android/settings/Settings.java         |  1 +
 src/com/android/settings/SettingsActivity.java | 19 +++++++++++++++++++
 5 files changed, 60 insertions(+)
 create mode 100644 res/drawable/ic_settings_magisk.xml

diff --git a/AndroidManifest.xml b/AndroidManifest.xml
index 03129a263..149424e11 100644
--- a/AndroidManifest.xml
+++ b/AndroidManifest.xml
@@ -3248,5 +3248,27 @@
             <meta-data android:name="com.android.settings.FRAGMENT_CLASS"
                 android:value="org.omnirom.omnigears.moresettings.OmniJawsSettings" />
             </activity>
+
+        <!-- Magisk Manager activity. -->
+        <activity android:name="Settings$MagiskActivity"
+            android:label="@string/magisk_title"
+            android:icon="@drawable/ic_settings_magisk"
+            android:taskAffinity="">
+            <intent-filter android:priority="4">
+                <action android:name="android.intent.action.MAIN" />
+                <category android:name="android.intent.category.DEFAULT" />
+                <category android:name="android.intent.category.VOICE_LAUNCH" />
+                <category android:name="com.android.settings.SHORTCUT" />
+            </intent-filter>
+            <intent-filter android:priority="9">
+                <action android:name="com.android.settings.action.SETTINGS" />
+            </intent-filter>
+            <meta-data android:name="com.android.settings.category"
+                android:value="com.android.settings.category.custom" />
+            <meta-data android:name="com.android.settings.FRAGMENT_CLASS"
+                android:value="com.android.settings.MagiskManager" />
+            <meta-data android:name="com.android.settings.summary"
+                android:resource="@string/magisk_summary" />
+        </activity>
     </application>
 </manifest>
diff --git a/res/drawable/ic_settings_magisk.xml b/res/drawable/ic_settings_magisk.xml
new file mode 100644
index 000000000..71a3344c1
--- /dev/null
+++ b/res/drawable/ic_settings_magisk.xml
@@ -0,0 +1,14 @@
+<?xml version="1.0" encoding="utf-8"?>
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:viewportWidth="12.7"
+    android:viewportHeight="12.7"
+    android:width="48dp"
+    android:height="48dp"
+    android:tint="?android:attr/colorAccent">
+    <group
+        android:translateY="-284.3">
+        <path
+            android:pathData="M5.9637128 295.58495c-0.1268234 -0.64093 -0.2305881 -1.62727 -0.2305881 -2.19187 0 -0.97177 0.032965 -1.02504 0.6178863 -0.99861 0.5971683 0.027 0.617902 0.07 0.6183563 1.28226 0.000413 1.10247 -0.439496 3.07356 -0.6859587 3.07356 -0.049009 0 -0.1928724 -0.5244 -0.3196958 -1.16534zM4.3938784 294.4552c-0.9211427 -0.91091 -0.9581208 -0.99041 -0.5002929 -1.07557 0.2719024 -0.0506 0.7274666 -0.30327 1.0123646 -0.56154l0.5179964 -0.46957 0 1.54441c0 0.84943 -0.00797 1.54474 -0.017703 1.54514 -0.00974 0.00041 -0.4653012 -0.44189 -1.0123651 -0.98287zm3.0394774 -0.72033l-0.01127 -1.44164 0.523089 0.52361c0.2876989 0.28798 0.7192755 0.52803 0.9590592 0.53345 0.3715777 0.008 0.314196 0.14341 -0.3885048 0.91413 -0.4534612 0.49736 -0.8799659 0.90604 -0.9477878 0.90819 -0.067822 0.002 -0.128385 -0.64484 -0.1345842 -1.43774zm-4.9466017 -1.3512c-0.3684372 -0.23113 -0.6698859 -0.51448 -0.6698859 -0.62966 0 -0.11519 0.2787426 -0.0325 0.6194279 0.1838 0.7223594 0.45857 1.7651895 0.15372 2.3664912 -0.6918 0.5439926 -0.76493 2.5977442 -0.69488 3.3562474 0.11449 0.7630663 0.81423 1.6638395 1.0254 2.3663513 0.55473 0.786406 -0.52686 0.712064 -0.25354 -0.103059 0.3789 -0.9209917 0.71459 -1.6364112 0.6538 -2.8717364 -0.24402 -1.1444958 -0.8318 -1.5525815 -0.79299 -2.5909366 0.24639 -0.6241095 0.62473 -1.5632222 0.65783 -2.4728999 0.0872zm0.2551089 -1.05115c-0.4052772 -0.51574 -0.718876 -1.49012 -0.718876 -2.23363 0 -0.47461 0.06775 -0.44296 0.5979937 0.27937 0.4567564 0.62223 0.7748848 0.81463 1.346944 0.81463l0.7489504 0 -0.7042689 0.78689c-0.8218996 0.91831 -0.8255111 0.91932 -1.2707432 0.35274zm6.0056036 -0.38648l-0.5927362 -0.75315 0.6370938 0c0.4186909 0 0.8868615 -0.27907 1.3656828 -0.81406 0.793621 -0.88672 0.830353 -0.8431 0.513308 0.6096 -0.183979 0.843 -0.8879743 1.8481 -1.2218855 1.7445 -0.0598 -0.0186 -0.3754578 -0.37265 -0.7014629 -0.78689zm-5.5341148 -1.42431c-0.4788157 -0.33067 -0.9842462 -1.10619 -0.9842462 -1.5102 0 -0.0646 0.3478254 0.0405 0.7729454 0.23354 0.4251199 0.19306 0.9413616 0.3562 1.1472037 0.36253 0.2058422 0.006 0.5703838 0.14508 0.8100923 0.30834 0.4220575 0.28744 0.4236415 0.30817 0.050114 0.65574 -0.4917086 0.45754 -1.0851376 0.44103 -1.7961086 -0.05zm4.6324902 0.23515c-0.5919484 -0.30396 -0.2101047 -0.84498 0.7887728 -1.11758 0.5755318 -0.15707 1.2327492 -0.41248 1.4604852 -0.56758 0.713044 -0.48562 0.670116 -0.0332 -0.08844 0.93209 -0.7000188 0.89081 -1.4104083 1.13839 -2.1608114 0.75307zm-1.2692878 -2.13862c-0.021848 -2.21174 0.2011451 -2.93358 0.9062453 -2.93358 0.4743709 0 0.4849013 0.0349 0.2179139 0.72131 -0.1542993 0.39672 -0.4660929 1.48853 -0.6928747 2.42624l-0.4123302 1.70492zm-0.6083196 0.86971c-0.1522562 -0.43279 -0.3258475 -1.22777 -0.3857589 -1.76661 -0.059911 -0.53885 -0.2360311 -1.11396 -0.3913779 -1.27803 -0.3955489 -0.41774 -0.3515819 -0.75865 0.097843 -0.75865 0.7753367 0 1.0871875 0.85321 1.0193022 2.78878 -0.061329 1.74863 -0.071289 1.77834 -0.3400084 1.01451zm-2.6522477 -0.42303c-0.876718 -0.32238 -1.2571748 -1.17969 -0.7861548 -1.77152 0.3156621 -0.39662 0.3581409 -0.38948 0.5723283 0.0962 0.1272475 0.28852 0.5028191 0.84918 0.8346035 1.2459 0.6282819 0.75126 0.4985338 0.84101 -0.620777 0.42944zm0.7131026 -1.06847l-1.0036274 -1.36035 0.5431353 -0.36214c0.6976638 -0.46517 1.0726154 -0.10545 1.2586689 1.20755 0.074604 0.52649 0.2194524 1.16381 0.3218846 1.41627 0.3379279 0.83288 -0.1014996 0.47926 -1.1200614 -0.90133zm3.6465117 0.93807c0.070492 -0.30439 0.2459107 -1.07095 0.3898207 -1.70348 0.2852086 -1.25356 0.6470361 -1.51149 1.2787679 -0.91155 0.3942846 0.37445 0.3705346 0.43527 -0.694252 1.77808 -0.7416124 0.93525 -1.0605492 1.20922 -0.9743366 0.83695zm1.3548516 -0.54222c0.3964641 -0.5515 0.7945284 -1.11977 0.884587 -1.26282 0.1773942 -0.28179 0.5501722 0.28458 0.5556602 0.84422 0.0041 0.40696 -0.7388052 1.00393 -1.5427345 1.23986l-0.6183563 0.18147z"
+            android:fillColor="?android:attr/colorAccent" />
+    </group>
+</vector>
diff --git a/res/values/projekt_strings.xml b/res/values/projekt_strings.xml
index d52f4ce7b..083970847 100644
--- a/res/values/projekt_strings.xml
+++ b/res/values/projekt_strings.xml
@@ -27,4 +27,8 @@
 
    <string name="substratum_title">Substratum</string>
 
+    <!-- Magisk Manager -->
+    <string name="magisk_title">Magisk Manager</string>
+    <string name="magisk_summary">Root management</string>
+
 </resources>
diff --git a/src/com/android/settings/Settings.java b/src/com/android/settings/Settings.java
index 2074ed2bd..143bfc08d 100644
--- a/src/com/android/settings/Settings.java
+++ b/src/com/android/settings/Settings.java
@@ -172,5 +172,6 @@ public class Settings extends SettingsActivity {
     public static class DevicePartsActivity extends SettingsActivity { /* empty */ }
     public static class OmniJawsSettingsActivity extends SettingsActivity { /* empty */ }
     public static class SubstratumActivity extends SettingsActivity { /* empty */ }
+    public static class SubstratumActivity extends SettingsActivity { /* empty */ }
 
 }
diff --git a/src/com/android/settings/SettingsActivity.java b/src/com/android/settings/SettingsActivity.java
index 41b880086..a36d533a3 100644
--- a/src/com/android/settings/SettingsActivity.java
+++ b/src/com/android/settings/SettingsActivity.java
@@ -244,6 +244,8 @@ public class SettingsActivity extends SettingsDrawerActivity
 
     private static final String SUBSTRATUM_FRAGMENT = "com.android.settings.Substratum";
 
+    private static final String MAGISK_FRAGMENT = "com.android.settings.MagiskManager";
+
     private String mFragmentClass;
 
     private CharSequence mInitialTitle;
@@ -1078,6 +1080,13 @@ public class SettingsActivity extends SettingsDrawerActivity
             finish();
             return null;
         }
+        if (MAGISK_FRAGMENT.equals(fragmentName)) {
+            Intent magiskIntent = new Intent();
+            magiskIntent.setClassName("com.topjohnwu.magisk", "com.topjohnwu.magisk.SplashActivity");
+            startActivity(magiskIntent);
+            finish();
+            return null;
+        }
         if (validate && !isValidFragment(fragmentName)) {
             throw new IllegalArgumentException("Invalid fragment for this activity: "
                     + fragmentName);
@@ -1233,6 +1242,16 @@ public class SettingsActivity extends SettingsDrawerActivity
         // Reveal development-only quick settings tiles
         DevelopmentTiles.setTilesEnabled(this, showDev);
 
+        // Magisk Manager
+        boolean magiskSupported = false;
+        try {
+            magiskSupported = (getPackageManager().getPackageInfo("com.topjohnwu.magisk", 0).versionCode > 0);
+        } catch (PackageManager.NameNotFoundException e) {
+        }
+        setTileEnabled(new ComponentName(packageName,
+                        Settings.MagiskActivity.class.getName()),
+                magiskSupported, isAdmin, pm);
+
         if (UserHandle.MU_ENABLED && !isAdmin) {
             // When on restricted users, disable all extra categories (but only the settings ones).
             List<DashboardCategory> categories = getDashboardCategories();
-- 
2.11.1

